<script>
(function() {
  var appRoot = document.querySelector('.app-root');
  var contentInner = document.querySelector('.app-content-inner');
  if (!appRoot || !contentInner) return;

  var base = document.querySelector('base') && document.querySelector('base').href
    ? new URL(document.querySelector('base').href).pathname.replace(/\/$/, '') || ''
    : '';

  function getPath(url) {
    try {
      var a = document.createElement('a');
      a.href = url;
      return a.pathname.replace(/\/$/, '') || '/';
    } catch (e) { return url; }
  }

  function isSameOrigin(href) {
    if (!href || href === '#' || href.startsWith('javascript:')) return false;
    try {
      var loc = window.location;
      var a = document.createElement('a');
      a.href = href;
      return a.origin === loc.origin;
    } catch (e) { return false; }
  }

  function shouldSkip(el) {
    return el.target === '_blank' || el.hasAttribute('download') ||
      el.getAttribute('rel') === 'external' || (el.getAttribute('href') || '').indexOf('/admin') === 0;
  }

  function setActive(path) {
    path = path.replace(/\/$/, '') || '/';
    var pathSegs = path.split('/').filter(Boolean);
    var groupKey = pathSegs[0] || '';
    var groupBase = pathSegs.length >= 2 ? '/' + pathSegs.slice(0, 3).join('/') + '/' : '';

    document.querySelectorAll('.app-nav-group').forEach(function(g) {
      var link = g.querySelector('.app-nav-item');
      var href = (link && link.getAttribute('href')) || '';
      var segs = href.split('/').filter(Boolean);
      var key = segs[0] || '';
      g.classList.toggle('active', key === groupKey);
    });
    document.querySelectorAll('.app-nav-item').forEach(function(a) {
      var href = (a.getAttribute('href') || '').replace(/\/$/, '') || '/';
      a.classList.toggle('active', href === path || (path.indexOf(href) === 0 && href !== '/'));
    });
    document.querySelectorAll('.app-nav-sub-item').forEach(function(a) {
      var href = (a.getAttribute('href') || '').replace(/\/$/, '') || '/';
      a.classList.toggle('active', href === path);
    });
    document.querySelectorAll('.app-topmenu-item').forEach(function(a) {
      var href = (a.getAttribute('href') || '').replace(/\/$/, '') || '/';
      var segs = href.split('/').filter(Boolean);
      var key = segs[0] || '';
      a.classList.toggle('active', key === groupKey);
    });
  }

  function loadPage(url, push) {
    var path = getPath(url);
    fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
      .then(function(r) { return r.text(); })
      .then(function(html) {
        var parser = new DOMParser();
        var doc = parser.parseFromString(html, 'text/html');
        var newContent = doc.querySelector('.app-content-inner');
        if (!newContent) {
          window.location.href = url;
          return;
        }
        contentInner.innerHTML = newContent.innerHTML;
        var title = doc.querySelector('title');
        if (title && title.textContent) document.title = title.textContent;
        if (push !== false) history.pushState({ path: path }, '', url);
        setActive(path);
        if (window.initSidebarPositionSelect) window.initSidebarPositionSelect();
        if (window.initSidebarCompactCheckbox) window.initSidebarCompactCheckbox();
      })
      .catch(function() { window.location.href = url; });
  }

  document.addEventListener('click', function(e) {
    var a = e.target.closest('a');
    if (!a || !isSameOrigin(a.href) || shouldSkip(a)) return;
    var full = (a.getAttribute('href') || '').trim();
    if (!full || full === '#' || full.indexOf('#') === 0) return;
    var path = getPath(full);
    var currentPath = getPath(location.href);
    if (path === currentPath) return;
    if (path === '' || path === '/') return;
    e.preventDefault();
    loadPage(a.href, true);
  }, true);

  window.addEventListener('popstate', function(e) {
    loadPage(location.href, false);
  });

  history.replaceState({ path: getPath(location.href) }, '', location.href);
  setActive(getPath(location.href));
})();
</script>
